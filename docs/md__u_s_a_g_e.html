<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>taiHEN: Usage</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">taiHEN
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">CFW framework for PS Vita</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Usage </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Quick Start </h2>
<p>Here are a couple of examples that demonstrate how to use the taiHEN APIs.</p>
<h3>Do something on startup</h3>
<p>Configure the following user plugin to load on an application named "AppName" with the title id "ABCD01234".</p>
<div class="fragment"><div class="line"><span class="comment">// handle to our hook</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="group__hook.html#gac10ef3a300e9826453a63ed3c1f0cc3f">tai_hook_ref_t</a> app_start_ref;</div><div class="line"><span class="comment">// our hook for app entry</span></div><div class="line"><span class="keywordtype">int</span> hook_app_start(SceSize argc, <span class="keyword">const</span> <span class="keywordtype">void</span> *args) {</div><div class="line">  printf(<span class="stringliteral">&quot;hello world!\n&quot;</span>);</div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="group__hook.html#ga2b5e8c88ef37e23a0664928410c0b7c8">TAI_CONTINUE</a>(<span class="keywordtype">int</span>, app_start_ref, argc, args);</div><div class="line">}</div><div class="line"><span class="comment">// our own plugin entry</span></div><div class="line"><span class="keywordtype">int</span> module_start(SceSize argc, <span class="keyword">const</span> <span class="keywordtype">void</span> *args) {</div><div class="line">  <a class="code" href="group__hook.html#gae05ef14d7925e68acaea4749ac6b79af">taiHookFunctionExport</a>(&amp;app_start_ref,  <span class="comment">// Output a reference</span></div><div class="line">                        <span class="stringliteral">&quot;AppName&quot;</span>,       <span class="comment">// Name of module being hooked</span></div><div class="line">                        <a class="code" href="group__taihen.html#gacd164ffaddd77a07b09309a1a7bc84ec">TAI_ANY_LIBRARY</a>, <span class="comment">// If there&#39;s multiple libs exporting this</span></div><div class="line">                        0x935CD196,      <span class="comment">// Special NID specifying module_start</span></div><div class="line">                        hook_app_start); <span class="comment">// Name of the hook function</span></div><div class="line">  <span class="keywordflow">return</span> SCE_KERNEL_START_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><p>We can build this as <code>myplugin.suprx</code> and add it to <code>ux0:tai/config.txt</code> under the section <code>*ABCD01234</code> and it will be loaded when <code>ABCD01234</code> is started and insert the hook.</p>
<h3>Logging Filesystem</h3>
<p>The following example will log all file opens from applications. Compile it as <code>kernellog.skprx</code> and add to <code>*KERNEL</code> section in <code>ux0:tai/config.txt</code>.</p>
<div class="fragment"><div class="line"><span class="comment">// handle to our hook</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="group__hook.html#gac10ef3a300e9826453a63ed3c1f0cc3f">tai_hook_ref_t</a> open_ref;</div><div class="line"><span class="comment">// this function is in kernel space</span></div><div class="line">SceUID hook_user_open(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> flags, SceMode mode, <span class="keywordtype">void</span> *args) {</div><div class="line">  <span class="keywordtype">char</span> k_path[256];</div><div class="line">  SceUID fd;</div><div class="line">  fd = <a class="code" href="group__hook.html#ga2b5e8c88ef37e23a0664928410c0b7c8">TAI_CONTINUE</a>(SceUID, open_ref, path, flags, mode, args);</div><div class="line">  <span class="comment">// we need to copy the user pointer to kernel space</span></div><div class="line">  sceKernelStrncpyUserToKernel(k_path, (uintptr_t)path, 256);</div><div class="line">  <span class="comment">// do some logging</span></div><div class="line">  printf(<span class="stringliteral">&quot;opening: %s, res: %x\n&quot;</span>, k_path, fd);</div><div class="line">  <span class="keywordflow">return</span> fd;</div><div class="line">}</div><div class="line"><span class="comment">// plugin entry</span></div><div class="line"><span class="keywordtype">int</span> module_start(SceSize argc, <span class="keyword">const</span> <span class="keywordtype">void</span> *args) {</div><div class="line">  <a class="code" href="group__hook.html#gab4da6ada9fcf53651839edc0b6e72611">taiHookFunctionExportForKernel</a>(<a class="code" href="group__taihen.html#ga504edcb943700beca9c23eba3fca56cd">KERNEL_PID</a>,      <span class="comment">// Kernel process</span></div><div class="line">                                 &amp;open_ref,       <span class="comment">// Output a reference</span></div><div class="line">                                 <span class="stringliteral">&quot;SceIofilemgr&quot;</span>,  <span class="comment">// Name of module being hooked</span></div><div class="line">                                 <a class="code" href="group__taihen.html#gacd164ffaddd77a07b09309a1a7bc84ec">TAI_ANY_LIBRARY</a>, <span class="comment">// If there&#39;s multiple libs exporting this</span></div><div class="line">                                 0xCC67B6FD,      <span class="comment">// NID specifying sceIoOpen</span></div><div class="line">                                 hook_user_open); <span class="comment">// Name of the hook function</span></div><div class="line">  <span class="keywordflow">return</span> SCE_KERNEL_START_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><h3>Chain of hooks</h3>
<p>Consider one kernel plugin with the code above. Now consider a second kernel plugin as follows.</p>
<div class="fragment"><div class="line"><span class="comment">// handle to our hook</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="group__hook.html#gac10ef3a300e9826453a63ed3c1f0cc3f">tai_hook_ref_t</a> another_open_ref;</div><div class="line"><span class="comment">// this function is in kernel space</span></div><div class="line">SceUID hook_user_open_differently(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> flags, SceMode mode, <span class="keywordtype">void</span> *args) {</div><div class="line">  <span class="keywordtype">char</span> k_path[256];</div><div class="line">  SceUID fd;</div><div class="line">  fd = <a class="code" href="group__hook.html#ga2b5e8c88ef37e23a0664928410c0b7c8">TAI_CONTINUE</a>(SceUID, another_open_ref, path, flags, mode, args);</div><div class="line">  <span class="comment">// we need to copy the user pointer to kernel space</span></div><div class="line">  sceKernelStrncpyUserToKernel(k_path, (uintptr_t)path, 256);</div><div class="line">  <span class="comment">// filter out certain paths</span></div><div class="line">  <span class="keywordflow">if</span> (strcmp(k_path, <span class="stringliteral">&quot;ux0:hidden_file.bin&quot;</span>) == 0 &amp;&amp; fd &gt;= 0) {</div><div class="line">    sceIoClose(fd); <span class="comment">// close the handle</span></div><div class="line">    fd = SCE_KERNEL_ERROR_NOENT;</div><div class="line">  }</div><div class="line">  <span class="keywordflow">return</span> fd;</div><div class="line">}</div><div class="line"><span class="comment">// another plugin entry</span></div><div class="line"><span class="keywordtype">int</span> module_start(SceSize argc, <span class="keyword">const</span> <span class="keywordtype">void</span> *args) {</div><div class="line">  <a class="code" href="group__hook.html#gab4da6ada9fcf53651839edc0b6e72611">taiHookFunctionExportForKernel</a>(<a class="code" href="group__taihen.html#ga504edcb943700beca9c23eba3fca56cd">KERNEL_PID</a>,                  <span class="comment">// Kernel process</span></div><div class="line">                                 &amp;another_open_ref,           <span class="comment">// Output a reference</span></div><div class="line">                                 <span class="stringliteral">&quot;SceIofilemgr&quot;</span>,              <span class="comment">// Name of module being hooked</span></div><div class="line">                                 <a class="code" href="group__taihen.html#gacd164ffaddd77a07b09309a1a7bc84ec">TAI_ANY_LIBRARY</a>,             <span class="comment">// If there&#39;s multiple libs exporting this</span></div><div class="line">                                 0xCC67B6FD,                  <span class="comment">// NID specifying sceIoOpen</span></div><div class="line">                                 hook_user_open_differently); <span class="comment">// Name of the hook function</span></div><div class="line">  <span class="keywordflow">return</span> SCE_KERNEL_START_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><p>Now we have both filesystem filtering <em>and</em> logging.</p>
<h3>Enabling dynarec</h3>
<p>This plugin will be loaded in kernel and changes the return value of a function that does a check to enable dynarec.</p>
<div class="fragment"><div class="line"><span class="comment">// handle to our hook</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="group__hook.html#gac10ef3a300e9826453a63ed3c1f0cc3f">tai_hook_ref_t</a> some_sysroot_check_hook;</div><div class="line"><span class="comment">// patch function</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> some_sysroot_check_patched(<span class="keywordtype">void</span>) {</div><div class="line">  <span class="comment">// It is important that we always call `TAI_CONTINUE` regardless if we need </span></div><div class="line">  <span class="comment">// the return value or not. This ensures other hooks in the chain can run!</span></div><div class="line">  <a class="code" href="group__hook.html#ga2b5e8c88ef37e23a0664928410c0b7c8">TAI_CONTINUE</a>(<span class="keywordtype">int</span>, some_sysroot_check_hook);</div><div class="line">  <span class="keywordflow">return</span> 1;</div><div class="line">}</div><div class="line"><span class="comment">// plugin entry</span></div><div class="line"><span class="keywordtype">int</span> module_start(SceSize argc, <span class="keyword">const</span> <span class="keywordtype">void</span> *args) {</div><div class="line">  <a class="code" href="group__hook.html#gab4da6ada9fcf53651839edc0b6e72611">taiHookFunctionExportForKernel</a>(<a class="code" href="group__taihen.html#ga504edcb943700beca9c23eba3fca56cd">KERNEL_PID</a>,                  <span class="comment">// Kernel process</span></div><div class="line">                                 &amp;some_sysroot_check_hook,    <span class="comment">// Output a reference</span></div><div class="line">                                 <span class="stringliteral">&quot;SceSysmem&quot;</span>,                 <span class="comment">// Name of module being hooked</span></div><div class="line">                                 0x3691DA45,                  <span class="comment">// NID specifying SceSysrootForKernel</span></div><div class="line">                                 0xF8769E86,                  <span class="comment">// NID of the export function we patch</span></div><div class="line">                                 some_sysroot_check_patched); <span class="comment">// Name of the hook function</span></div><div class="line">  <span class="keywordflow">return</span> SCE_KERNEL_START_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><h3>Local file logging</h3>
<p>The above examples are all global hooks: every call regardless of origin will be hooked. You can also insert local hooks: a library import from a module. In this example, we have a user plugin loaded with "AppName" that only logs <code>sceIoOpen</code> calls from that application.</p>
<div class="fragment"><div class="line"><span class="comment">// handle to our hook</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="group__hook.html#gac10ef3a300e9826453a63ed3c1f0cc3f">tai_hook_ref_t</a> local_open_hook;</div><div class="line"><span class="comment">// this function is in user space now</span></div><div class="line">SceUID hook_local_open(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> flags, SceMode mode) {</div><div class="line">  SceUID fd;</div><div class="line">  fd = <a class="code" href="group__hook.html#ga2b5e8c88ef37e23a0664928410c0b7c8">TAI_CONTINUE</a>(SceUID, local_open_hook, path, flags, mode);</div><div class="line">  printf(<span class="stringliteral">&quot;open in AppName: %s, ret: %x&quot;</span>, path, fd);</div><div class="line">  <span class="keywordflow">return</span> fd;</div><div class="line">}</div><div class="line"><span class="comment">// our own plugin entry</span></div><div class="line"><span class="keywordtype">int</span> module_start(SceSize argc, <span class="keyword">const</span> <span class="keywordtype">void</span> *args) {</div><div class="line">  <a class="code" href="group__hook.html#ga795597abd9e27d4e9e3f556b12d8a402">taiHookFunctionImport</a>(&amp;local_open_hook,  <span class="comment">// Output a reference</span></div><div class="line">                        <span class="stringliteral">&quot;AppName&quot;</span>,         <span class="comment">// Name of module being hooked</span></div><div class="line">                        0xCAE9ACE6,        <span class="comment">// NID specifying SceLibKernel, a wrapper library</span></div><div class="line">                        0x6C60AC61,        <span class="comment">// NID specifying sceIoOpen</span></div><div class="line">                        hook_local_open);  <span class="comment">// Name of the hook function</span></div><div class="line">  <span class="keywordflow">return</span> SCE_KERNEL_START_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><h2>Advanced Usage </h2>
<p>Below are some common tasks and paradigms that might be of interest to people writing advanced hooks.</p>
<h3>Hooking shared libraries</h3>
<p>Currently taiHEN does not support hooking the exports of shared libraries (or the imports from shared libraries). Shared libraries are ones loaded in the <code>0xE0000000</code> address range and are mainly in modules that most applications import from (example being <code>SceLibKernel</code> and <code>SceGxm</code>). You can, however, hook imports of shared libraries as usual. So, if multiple non-shared modules import a function of interest, you must hook all of them (if desired).</p>
<h3>Hooking weak imports</h3>
<p>Weak imports are imports of modules not loaded at application startup and are loaded by <code>sceSysmoduleLoadModule</code> (in <code>SceSysmodule</code>) or <code>sceKernelLoadStartModule</code> (in <code>SceLibKernel</code>) or some other function. They typically are loaded on-demand and unloaded when no longer needed to save memory. That means that your hooks must be created after the module is loaded and removed before the module is unloaded. To do this, you have to first hook the module load and unload imports and in those hooks, you create/remove the desired hook. In this example, we wish to hook <code>sceScreenShotDisable</code> which is loaded by the game from <code>sceSysmoduleLoadModule</code>.</p>
<div class="fragment"><div class="line"><span class="comment">// handle to our hooks</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="group__hook.html#gac10ef3a300e9826453a63ed3c1f0cc3f">tai_hook_ref_t</a> load_hook;</div><div class="line"><span class="keyword">static</span> <a class="code" href="group__hook.html#gac10ef3a300e9826453a63ed3c1f0cc3f">tai_hook_ref_t</a> unload_hook;</div><div class="line"><span class="keyword">static</span> <a class="code" href="group__hook.html#gac10ef3a300e9826453a63ed3c1f0cc3f">tai_hook_ref_t</a> ss_disable_hook;</div><div class="line"><span class="keyword">static</span> SceUID ss_disable_uid;</div><div class="line"><span class="comment">// hook to never disable screenshots</span></div><div class="line"><span class="keywordtype">int</span> hook_ss_disable(<span class="keywordtype">void</span>) {</div><div class="line">  <span class="keywordtype">int</span> ret;</div><div class="line">  <a class="code" href="group__hook.html#ga2b5e8c88ef37e23a0664928410c0b7c8">TAI_CONTINUE</a>(<span class="keywordtype">int</span>, ss_disable_hook); <span class="comment">// so others get a chance to hook</span></div><div class="line">  ret = sceScreenShotEnable(); <span class="comment">// we always re-enable ss</span></div><div class="line">  <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"><span class="comment">// hook load module</span></div><div class="line"><span class="keywordtype">int</span> hook_sysmodule_load(uint16_t <span class="keywordtype">id</span>) {</div><div class="line">  <span class="keywordtype">int</span> ret;</div><div class="line">  ret = <a class="code" href="group__hook.html#ga2b5e8c88ef37e23a0664928410c0b7c8">TAI_CONTINUE</a>(<span class="keywordtype">int</span>, load_hook, <span class="keywordtype">id</span>);</div><div class="line">  <span class="keywordflow">if</span> (ret &gt;= 0) { <span class="comment">// load successful</span></div><div class="line">    <span class="keywordflow">switch</span> (<span class="keywordtype">id</span>) {</div><div class="line">      <span class="keywordflow">case</span> SCE_SYSMODULE_SCREEN_SHOT:</div><div class="line">        ss_disable_uid = </div><div class="line">          <a class="code" href="group__hook.html#ga795597abd9e27d4e9e3f556b12d8a402">taiHookFunctionImport</a>(&amp;ss_disable_hook, <span class="comment">// Output a reference</span></div><div class="line">                        <span class="stringliteral">&quot;AppName&quot;</span>,                <span class="comment">// Name of module being hooked</span></div><div class="line">                        0xF26FC97D,               <span class="comment">// NID specifying SceScreenShot</span></div><div class="line">                        0x50AE9FF9,               <span class="comment">// NID specifying sceScreenShotDisable</span></div><div class="line">                        hook_ss_disable);         <span class="comment">// Name of the hook function</span></div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">      <span class="comment">// you can consider other loaded modules too here ...</span></div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"><span class="comment">// hook unload module</span></div><div class="line"><span class="keywordtype">int</span> hook_sysmodule_unload(uint16_t <span class="keywordtype">id</span>) {</div><div class="line">  <span class="keywordtype">int</span> ret;</div><div class="line">  ret = <a class="code" href="group__hook.html#ga2b5e8c88ef37e23a0664928410c0b7c8">TAI_CONTINUE</a>(<span class="keywordtype">int</span>, unload_hook, <span class="keywordtype">id</span>);</div><div class="line">  <span class="keywordflow">if</span> (ret &gt;= 0) { <span class="comment">// unload successful</span></div><div class="line">    <span class="keywordflow">switch</span> (<span class="keywordtype">id</span>) {</div><div class="line">      <span class="keywordflow">case</span> SCE_SYSMODULE_SCREEN_SHOT:</div><div class="line">        <span class="keywordflow">if</span> (ss_disable_uid &gt;= 0) {</div><div class="line">          <a class="code" href="group__hook.html#ga23d24ea46116a54698618af35b39aea6">taiHookRelease</a>(ss_disable_uid, ss_disable_hook);</div><div class="line">          ss_disable_uid = -1;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">      <span class="comment">// you can consider other loaded modules too here ...</span></div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"><span class="comment">// our own plugin entry</span></div><div class="line"><span class="keywordtype">int</span> module_start(SceSize argc, <span class="keyword">const</span> <span class="keywordtype">void</span> *args) {</div><div class="line">  ss_disable_uid = -1;</div><div class="line">  <a class="code" href="group__hook.html#ga795597abd9e27d4e9e3f556b12d8a402">taiHookFunctionImport</a>(&amp;load_hook,             <span class="comment">// Output a reference</span></div><div class="line">                        <span class="stringliteral">&quot;AppName&quot;</span>,              <span class="comment">// Name of module being hooked</span></div><div class="line">                        0x03FCF19D,             <span class="comment">// NID specifying SceSysmodule</span></div><div class="line">                        0x79A0160A,             <span class="comment">// NID specifying sceSysmoduleLoadModule</span></div><div class="line">                        hook_sysmodule_load);   <span class="comment">// Name of the hook function</span></div><div class="line">  <a class="code" href="group__hook.html#ga795597abd9e27d4e9e3f556b12d8a402">taiHookFunctionImport</a>(&amp;unload_hook,           <span class="comment">// Output a reference</span></div><div class="line">                        <span class="stringliteral">&quot;AppName&quot;</span>,              <span class="comment">// Name of module being hooked</span></div><div class="line">                        0x03FCF19D,             <span class="comment">// NID specifying SceSysmodule</span></div><div class="line">                        0x31D87805,             <span class="comment">// NID specifying sceSysmoduleUnloadModule</span></div><div class="line">                        hook_sysmodule_unload); <span class="comment">// Name of the hook function</span></div><div class="line">  <span class="keywordflow">return</span> SCE_KERNEL_START_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><h3>Loading a kernel plugin on demand</h3>
<p>You can specify <code>suprx</code> to load with specific titles, but you cannot do so with <code>skprx</code>. This is a limitation of the Vita kernel. A workaround is to use the taiHEN APIs to manually load and unload the kernel module directly. Please note this feature only works with unsafe homebrew enabled. Be aware that <code>module_stop</code> of your user plugin is not automatically called so you should not use that to cleanup your kernel plugin. Instead, your kernel plugin's <code>module_start</code> can return <code>SCE_KERNEL_START_NO_RESIDENT</code> to be cleaned up automatically after running. In the case that it is not possible, you should be careful not to load the same kernel module twice.</p>
<p>It it important to remember to always clean up hooks and injections in <code>module_stop</code> for kernel modules. You should be doing this for user modules as well, but patches in user-space will be cleaned up by taiHEN when the process exits. Patches in kernel will not be cleaned up automatically.</p>
<h3>Syscall stack limitations</h3>
<p>When writing a kernel module that exposes new syscalls, know that the syscall stack is only 4096 bytes. That means you might easily run out of space. You should use <code>sceKernelRunWithStack</code> to increase the stack size if needed.</p>
<h3>Unloading a kernel module that exposes syscalls</h3>
<p>By default, the Vita does not allow unloading modules that exposes syscalls (you will get <code>SCE_KERNEL_ERROR_MODULEMGR_IN_USE</code>). To get around this, you can hook an override function in the module manager. This hook will be released when the module is unloaded.</p>
<div class="fragment"><div class="line"><span class="comment">// handles</span></div><div class="line"><span class="keyword">static</span> hook_ref_t unload_allowed_hook;</div><div class="line"><span class="keyword">static</span> SceUID unload_allowed_uid;</div><div class="line"><span class="comment">// patch</span></div><div class="line"><span class="keywordtype">int</span> unload_allowed_patched(<span class="keywordtype">void</span>) {</div><div class="line">  <span class="keywordtype">int</span> ret;</div><div class="line">  ret = <a class="code" href="group__hook.html#ga2b5e8c88ef37e23a0664928410c0b7c8">TAI_CONTINUE</a>(<span class="keywordtype">int</span>, unload_allowed_hook);</div><div class="line">  <span class="keywordflow">return</span> 1; <span class="comment">// always allowed</span></div><div class="line">}</div><div class="line"><span class="comment">// kernel plugin entry</span></div><div class="line"><span class="keywordtype">int</span> module_start(SceSize argc, <span class="keyword">const</span> <span class="keywordtype">void</span> *args) {</div><div class="line">  unload_allowed_uid = </div><div class="line">    <a class="code" href="group__hook.html#ga6db61f90fde2aded4b94fbd2bfd808ba">taiHookFunctionImportForKernel</a>(<a class="code" href="group__taihen.html#ga504edcb943700beca9c23eba3fca56cd">KERNEL_PID</a>, </div><div class="line">                          &amp;unload_allowed_hook,     <span class="comment">// Output a reference</span></div><div class="line">                          <span class="stringliteral">&quot;SceKernelModulemgr&quot;</span>,     <span class="comment">// Name of module being hooked</span></div><div class="line">                          0x11F9B314,               <span class="comment">// NID specifying SceSblACMgrForKernel</span></div><div class="line">                          0xBBA13D9C,               <span class="comment">// Function NID</span></div><div class="line">                          unload_allowed_patched);  <span class="comment">// Name of the hook function</span></div><div class="line">  <span class="comment">// do other things here...</span></div><div class="line">  <span class="keywordflow">return</span> SCE_KERNEL_START_SUCCESS;</div><div class="line">}</div><div class="line"><span class="comment">// cleanup</span></div><div class="line"><span class="keywordtype">int</span> module_stop(SceSize argc, <span class="keyword">const</span> <span class="keywordtype">void</span> *args) {</div><div class="line">  <span class="comment">// don&#39;t forget to clean up</span></div><div class="line">  <a class="code" href="group__hook.html#gaa71cf17b830797d64f7f21158139e967">taiHookReleaseForKernel</a>(<a class="code" href="group__taihen.html#ga504edcb943700beca9c23eba3fca56cd">KERNEL_PID</a>, unload_allowed_uid, unload_allowed_hook);</div><div class="line">  <span class="comment">// do other things here...</span></div><div class="line">  <span class="keywordflow">return</span> SCE_KERNEL_STOP_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><h3>Hooking a function while it is being called</h3>
<p>There is currently a <a href="https://github.com/yifanlu/taiHEN/issues/12">bug</a> in the implementation where a crash may happen if you are hooking a function while it is being used. Usually this doesn't happen (except by chance), but some functions might be called in a tight loop. A temporary workaround is listed in the <a href="https://github.com/yifanlu/taiHEN/issues/12">issue tracker</a>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.12
</small></address>
</body>
</html>
